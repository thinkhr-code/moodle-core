define(["jquery","core/ajax","core/templates","core/notification","core/str","core/yui","core/pending"],function(a,b,c,d,e,f,g){return{initTagindexPage:function(){a("body").delegate(".tagarea[data-ta] a[data-quickload=1]","click",function(e){var f=new g("core/tag:initTagindexPage");e.preventDefault();var h=a(this),i=h[0].search.replace(/^\?/,""),j=h.closest(".tagarea[data-ta]"),k=i.split("&").reduce(function(a,b){var c=b.split("=");return a[c[0]]=decodeURIComponent(c[1]),a},{});b.call([{methodname:"core_tag_get_tagindex",args:{tagindex:k}}])[0].then(function(a){return c.render("core_tag/index",a)}).then(function(a,b){c.replaceNode(j,a,b)}).always(f.resolve)["catch"](d.exception)})},initManagePage:function(){a("body").on("updated","[data-inplaceeditable]",function(b){var c=new g("core/tag:initManagePage");if(e.get_strings([{key:"selecttag",component:"core_tag"},{key:"now",component:"core"}]).then(function(c){a('label[for="tagselect'+b.ajaxreturn.itemid+'"]').html(c[0]),a(b.target).closest("tr").find("td.col-timemodified").html(c[1])}).always(c.resolve)["catch"](d.exception),"tagflag"===b.ajaxreturn.itemtype){var f=a(b.target).closest("tr");"0"===b.ajaxreturn.value?f.removeClass("flagged-tag"):f.addClass("flagged-tag")}}),a(".tag-management-table").delegate("a.tagdelete","click",function(b){var c=new g("core/tag:tagdelete");b.preventDefault();var f=a(this).attr("href");e.get_strings([{key:"delete",component:"core"},{key:"confirmdeletetag",component:"tag"},{key:"yes",component:"core"},{key:"no",component:"core"}]).then(function(a){return d.confirm(a[0],a[1],a[2],a[3],function(){window.location.href=f})}).always(c.resolve)["catch"](d.exception)}),a("#tag-management-delete").click(function(b){var c=a(this).closest("form").get(0),f=a(c).find("input[type=checkbox]:checked").length;if(f){var h=new g("core/tag:tag-management-delete"),i=a("<input type='hidden'/>").attr("name",this.name);b.preventDefault(),e.get_strings([{key:"delete",component:"core"},{key:"confirmdeletetags",component:"tag"},{key:"yes",component:"core"},{key:"no",component:"core"}]).then(function(a){return d.confirm(a[0],a[1],a[2],a[3],function(){i.appendTo(c),c.submit()})}).always(h.resolve)["catch"](d.exception)}}),a("#tag-management-combine").click(function(b){var c=new g("core/tag:tag-management-combine");b.preventDefault();var h=a(this).closest("form").get(0),i=a(h).find("input[type=checkbox]:checked");if(i.length<=1)return void e.get_strings([{key:"combineselected",component:"tag"},{key:"selectmultipletags",component:"tag"},{key:"ok"}]).then(function(a){return d.alert(a[0],a[1],a[2])}).always(c.resolve)["catch"](d.exception);var j=a("<input type='hidden'/>").attr("name",this.name);e.get_strings([{key:"combineselected",component:"tag"},{key:"selectmaintag",component:"tag"},{key:"continue"},{key:"cancel"}]).then(function(b){var c=a('<div><form id="combinetags_form"><div class="description"></div><div class="form-group options"></div><div class="form-group">   <input type="submit" class="btn btn-primary" id="combinetags_submit"/>   <input type="button" class="btn btn-secondary" id="combinetags_cancel"/></div></form></div>');c.find(".description").html(b[1]),c.find("#combinetags_submit").attr("value",b[2]),c.find("#combinetags_cancel").attr("value",b[3]);var d=c.find(".options");i.each(function(){var b=a(this).val(),c=a(".inplaceeditable[data-itemtype=tagname][data-itemid="+b+"]").attr("data-value"),e='<div class="form-check">   <input type="radio" class="form-check-input" name="maintag"        id="combinetags_maintag_'+b+'" value="'+b+'"/>   <label class="form-check-label" for="combinetags_maintag_'+b+'">'+c+"</label></div>";d.append(a(e))}),f.use("moodle-core-notification-dialogue",function(){var d=new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,headerContent:b[0],bodyContent:c.html()});d.show(),a("#combinetags_form input[type=radio]").first().focus().prop("checked",!0),a("#combinetags_form #combinetags_cancel").on("click",function(){d.destroy()}),a("#combinetags_form").on("submit",function(){j.appendTo(h);var b=a("input[name=maintag]:checked","#combinetags_form").val();return a("<input type='hidden'/>").attr("name","maintag").attr("value",b).appendTo(h),h.submit(),!1})})}).always(c.resolve)["catch"](d.exception)}),a("body").on("updatefailed","[data-inplaceeditable][data-itemtype=tagname]",function(b){var c=b.exception,f=b.newvalue,h=a(b.target).attr("data-itemid");if("namesalreadybeeingused"===c.errorcode){var i=new g("core/tag:tag-management-combine-exists");b.preventDefault(),e.get_strings([{key:"nameuseddocombine",component:"tag"},{key:"yes"},{key:"cancel"}]).then(function(a){return d.confirm(b.message,a[0],a[1],a[2],function(){window.location.href=window.location.href+"&newname="+encodeURIComponent(f)+"&tagid="+encodeURIComponent(h)+"&action=renamecombine&sesskey="+M.cfg.sesskey})}).always(i.resolve)["catch"](d.exception)}}),a("body").on("click","a[data-action=addstandardtag]",function(b){var c=new g("core/tag:addstandardtag");b.preventDefault(),e.get_strings([{key:"addotags",component:"tag"},{key:"inputstandardtags",component:"tag"},{key:"continue",component:"core"},{key:"cancel",component:"core"}]).then(function(b){var d=a('<div><form id="addtags_form" method="POST"><input type="hidden" name="action" value="addstandardtag"/><input type="hidden" name="sesskey" value="'+M.cfg.sesskey+'"/><div class="form-group">   <label for="id_tagslist">'+b[1]+'</label>   <input type="text" id="id_tagslist" class="form-control" name="tagslist"/></div><div class="form-group">   <input type="submit" class="btn btn-primary" id="addtags_submit"/>   <input type="button" class="btn btn-secondary" id="addtags_cancel"/></div></form></div>');d.find("#addtags_form").attr("action",window.location.href),d.find("#addtags_submit").attr("value",b[2]),d.find("#addtags_cancel").attr("value",b[3]),f.use("moodle-core-notification-dialogue",function(){var e=new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,headerContent:b[0],bodyContent:d.html()});e.show(),a("#addtags_form input[type=text]").focus(),a("#addtags_form #addtags_cancel").on("click",function(){e.destroy()}),c.resolve()})})["catch"](d.exception)})},initManageCollectionsPage:function(){a("body").on("updated","[data-inplaceeditable]",function(b){var c,d,e,f=new g("core/tag:initManageCollectionsPage-updated"),h=b.ajaxreturn;"core_tag"===h.component&&"tagareaenable"===h.itemtype&&(c=a(this).attr("data-itemid"),a(".tag-collections-table ul[data-collectionid] li[data-areaid="+c+"]").hide(),e=h.value,"1"===e?(a(this).closest("tr").removeClass("dimmed_text"),d=a(this).closest("tr").find('[data-itemtype="tagareacollection"]').attr("data-value"),a(".tag-collections-table ul[data-collectionid="+d+"] li[data-areaid="+c+"]").show()):a(this).closest("tr").addClass("dimmed_text")),"core_tag"===h.component&&"tagareacollection"===h.itemtype&&(c=a(this).attr("data-itemid"),a(".tag-collections-table ul[data-collectionid] li[data-areaid="+c+"]").hide(),d=a(this).attr("data-value"),e=a(this).closest("tr").find('[data-itemtype="tagareaenable"]').attr("data-value"),"1"===e&&a(".tag-collections-table ul[data-collectionid="+d+"] li[data-areaid="+c+"]").show()),f.resolve()}),a("body").on("click",".addtagcoll > a",function(b){var c=new g("core/tag:initManageCollectionsPage-addtagcoll");b.preventDefault();var h=a(this).attr("data-url")+"&sesskey="+M.cfg.sesskey;e.get_strings([{key:"addtagcoll",component:"tag"},{key:"name"},{key:"searchable",component:"tag"},{key:"create"},{key:"cancel"}]).then(function(b){var d=a('<div><form id="addtagcoll_form"><div class="form-group">   <label for="addtagcoll_name"></label>    <input id="addtagcoll_name" type="text" class="form-control"/>  </div><div class="form-group form-check">   <input id="addtagcoll_searchable" type="checkbox" value="1" checked class="form-check-input"/>   <label for="addtagcoll_searchable" class="form-check-label"></label></div><div class="form-group">   <input type="submit" class="btn btn-primary" id="addtagcoll_submit"/>   <input type="button" class="btn btn-secondary" id="addtagcoll_cancel"/></div></form></div>');d.find('label[for="addtagcoll_name"]').html(b[1]),d.find('label[for="addtagcoll_searchable"]').html(b[2]),d.find("#addtagcoll_submit").attr("value",b[3]),d.find("#addtagcoll_cancel").attr("value",b[4]),f.use("moodle-core-notification-dialogue",function(){var e=new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,headerContent:b[0],bodyContent:d.html()});e.show(),a("#addtagcoll_form #addtagcoll_name").focus(),a("#addtagcoll_form #addtagcoll_cancel").on("click",function(){e.destroy()}),a("#addtagcoll_form").on("submit",function(){var b=a("#addtagcoll_form #addtagcoll_name").val(),c=a("#addtagcoll_form #addtagcoll_searchable").prop("checked")?1:0;return String(b).length>0&&(window.location.href=h+"&name="+encodeURIComponent(b)+"&searchable="+c),!1}),c.resolve()})})["catch"](d.exception)}),a("body").on("click",".tag-collections-table .action_delete",function(b){var c=new g("core/tag:initManageCollectionsPage-action_delete");b.preventDefault();var f=a(this).attr("data-url")+"&sesskey="+M.cfg.sesskey;e.get_strings([{key:"delete"},{key:"suredeletecoll",component:"tag",param:a(this).attr("data-collname")},{key:"yes"},{key:"no"}]).then(function(a){return d.confirm(a[0],a[1],a[2],a[3],function(){window.location.href=f})}).always(c.resolve)["catch"](d.exception)})}}});